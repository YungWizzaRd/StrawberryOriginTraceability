<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Strawberry Origin Traceability</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light p-4">
  <div class="container">
    <h1 class="text-center mb-4">üçì Strawberry Origin Traceability</h1>

    <!-- Add Product Section -->
    <div class="card p-3 mb-4">
      <h5>Add New Product</h5>
      <input id="pid" class="form-control mb-2" placeholder="Product ID">
      <input id="pname" class="form-control mb-2" placeholder="Product Name">
      <input id="porigin" class="form-control mb-2" placeholder="Origin (Farm)">
      <input id="pdate" type="date" class="form-control mb-2" aria-label="Harvest Date">
      <input id="pproducer" class="form-control mb-2" placeholder="Producer Name">
      <button class="btn btn-primary" onclick="addProduct()">Add Product</button>
      <div id="qrcode" class="mt-3 text-center"></div>
      <button id="printQR" class="btn btn-secondary mt-3" style="display:none;">Print QR Code</button>
      <script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
    </div>

    <!-- Update Product Section -->
    <div class="card p-3 mb-4">
      <h5>Update Product Status</h5>
      <input id="upid" class="form-control mb-2" placeholder="Product ID">
      <input id="uparticipant" class="form-control mb-2" placeholder="Participant (Processor/Retailer)">
      <input id="uevent" class="form-control mb-2" placeholder="Event (Stored/Delivered)">
      <input id="udate" class="form-control mb-2" placeholder="Date">
      <button class="btn btn-success" onclick="updateProduct()">Update Product</button>
    </div>

    <!-- View Product Timeline -->
    <div class="card p-3 mb-4">
      <h5>View Product Timeline</h5>
      <input id="gid" class="form-control mb-2" placeholder="Product ID">
      <button class="btn btn-info mb-3" onclick="getHistory()">Get History</button>
      <pre id="output"></pre>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.min.js"></script>
  <script src="app.js"></script>
  <script>
    // Persistent product ID counter
    let productCounter = localStorage.getItem("productCounter")
      ? parseInt(localStorage.getItem("productCounter"))
      : 0;

          function formatDateString(dateValue) {
      if (!dateValue) return "";
      const parsed = new Date(dateValue);
      return Number.isNaN(parsed.getTime())
        ? dateValue
        : parsed.toLocaleDateString(undefined, {
            year: "numeric",
            month: "long",
            day: "numeric",
          });
    }
    document.addEventListener("DOMContentLoaded", () => {
      productCounter++;
      const newId = "P" + String(productCounter).padStart(4, "0");
      const pidField = document.getElementById("pid");
      pidField.value = newId;
      pidField.readOnly = true;
      localStorage.setItem("productCounter", productCounter);
      const harvestDateField = document.getElementById("pdate");
      if (harvestDateField && !harvestDateField.value) {
        harvestDateField.value = new Date().toISOString().split("T")[0];
      }
    });

    // Function to create QR only
    async function generateQR() {
      const pid = document.getElementById("pid").value;
      const pname = document.getElementById("pname").value.trim();
      const porigin = document.getElementById("porigin").value.trim();
      const pdate = document.getElementById("pdate").value.trim();
      const pproducer = document.getElementById("pproducer").value.trim();

      if (!pname || !porigin || !pdate || !pproducer) {
        alert("Please fill in all fields before adding the product.");
        return;
      }

      const qrContainer = document.getElementById("qrcode");
      qrContainer.innerHTML = "";
      document.getElementById("printQR").style.display = "none";

      try {
        const canvas = document.createElement("canvas");
        qrContainer.appendChild(canvas);

        const readableDate = formatDateString(pdate) || pdate;
        const qrText = `Product ID: ${pid}\nName: ${pname}\nOrigin: ${porigin}\nHarvest Date: ${readableDate}\nProducer: ${pproducer}`;
        await QRCode.toCanvas(canvas, qrText);
        document.getElementById("printQR").style.display = "inline-block";
      } catch (err) {
        console.error("QR generation error:", err);
        alert("Could not generate QR code.");
      }
    }

    // Combined function ‚Üí runs MetaMask logic from app.js + QR generator
    async function addProduct() {
      let created = false;
      try {
        // Call blockchain createProduct() from app.js (MetaMask)
        if (typeof createProduct === "function") {
          created = await createProduct();
        } else {
          console.warn("createProduct() not found in app.js");
        }
      } catch (err) {
        console.error("Blockchain error:", err);
      }

      // Only generate QR code when product creation succeeds
      if (created) {
        await generateQR();
      }
    }

    // Print QR Code
    document.getElementById("printQR").addEventListener("click", function() {
      const qrCanvas = document.querySelector("#qrcode canvas");
      if (!qrCanvas) {
        alert("No QR code available to print.");
        return;
      }

      const qrImage = qrCanvas.toDataURL("image/png");
      const newWindow = window.open("", "", "width=400,height=400");
      newWindow.document.write(`
        <html><head><title>Print QR Code</title></head>
        <body style="text-align:center; font-family:Arial;">
          <h3>Product QR Code</h3>
          <img src="${qrImage}" alt="QR Code"><br>
          <button onclick="window.print()">Print</button>
        </body></html>
      `);
      newWindow.document.close();
    });
  </script>
</body>
</html>
